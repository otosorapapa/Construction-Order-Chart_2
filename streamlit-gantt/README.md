# 工事受注案件の予定表（ガントチャート）

工事受注案件の予定表を Web ベースで管理する Streamlit アプリケーションです。案件の検索・フィルタリング、クリック編集、CSV/JSON での入出力、PNG ダウンロードなどを備えています。

## セットアップ

Python 3.11 以降を利用してください。

```bash
# 仮想環境の作成
python -m venv venv
# macOS / Linux
source venv/bin/activate
# Windows (PowerShell)
venv\\Scripts\\Activate.ps1

# 依存ライブラリのインストール
pip install -r requirements.txt

# アプリの起動
streamlit run app.py
```

## 使い方

1. **案件一覧とガント表示**
   - 左ペインのフィルタで期間・検索文字列・工種・進捗・担当者を指定すると、右側のガントチャートと案件一覧が連動します。
   - 案件一覧にはチェックボックス列があり、チェックした案件はガントチャートで強調表示されます。キーボードの ↑/↓ や Enter でデータエディタを操作できます。

2. **クリック編集**
   - ガントチャート上のバーをクリックすると右側に編集フォームが表示され、開始日・終了日・ラベル・進捗・メモ・バー色を編集できます。
   - 変更は `保存` ボタンで適用され、Ctrl+Z / Ctrl+Y（または上部のボタン）で Undo/Redo できます。

3. **CSV/JSON 入力**
   - サイドバーの「データ入出力 > インポート」で CSV/JSON を読み込み、必要な列をマッピングして取り込みます。
   - 必須列: `name`, `client`, `site`, `work_type`, `owner`, `progress`, `start_date`, `end_date`
   - 取り込み後は既存データが置き換わります。読み込みエラーは画面上に表示されます。

4. **CSV/JSON 出力**
   - 「データ入出力 > エクスポート」では、現在のフィルタ結果または全件を CSV/JSON でダウンロードできます。

5. **PNG 出力 / 印刷**
   - ガントチャートの下にある `PNG 出力` ボタンでカレントビューを PNG 形式で保存できます（内部で kaleido を使用）。
   - PDF 化はブラウザの印刷機能で行ってください。A3 横向き・余白小がおすすめです。

6. **表示設定**
   - グリッド（週/日/なし）、今日ライン、ズームレベル（週/月/四半期）を切り替えられます。
   - 今日ラインは表示期間内に本日が含まれている場合のみ描画されます。

## データ仕様 / カラムマッピング

| 列名 | 説明 |
| ---- | ---- |
| `name` | 案件名 |
| `client` | 顧客名 |
| `site` | 現場 |
| `work_type` | 工種（建築/土木/その他） |
| `owner` | 担当者 |
| `progress` | 進捗（予定/進行/完了） |
| `start_date` | 開始日（YYYY-MM-DD） |
| `end_date` | 終了日（YYYY-MM-DD、開始日以上） |
| `label` | セグメント名（任意、未指定なら「工期」） |
| `note` | メモ（任意） |
| `color` | バー色の HEX（任意、未指定はオレンジ） |

CSV/JSON インポート時は上記列をマッピングすると、案件と単一セグメントのデータとして取り込まれます。複数セグメントが必要な場合は、取り込み後にクリック編集で追加区間を登録してください。

## 既知の制約

- Plotly の仕様によりバーのドラッグや直接リサイズはできません。バーをクリックして日付入力 UI から修正してください。
- Undo/Redo はセッション内のみ有効で、履歴は最大 20 ステップです。
- PNG 出力には kaleido が必要です。環境によっては初回実行時に数秒かかることがあります。

## 開発メモ

- テーマ設定は `.streamlit/config.toml` でオレンジ系を基調としています。明暗どちらのテーマでも読みやすい配色を選択しています。
- 単体テストは `pytest` で `tests/test_dates.py` を実行してください。
